# =============================================================================
# Docker Compose for Kanboard MCP Server Testing
# Demonstrates different transport modes
# =============================================================================
#
# Usage:
#   # Start SSE mode (default)
#   docker-compose up mcp-sse
#
#   # Start Streamable HTTP mode
#   docker-compose up mcp-http
#
#   # Start stdio mode (for interactive testing)
#   docker-compose run --rm mcp-stdio
#
#   # Start all HTTP services
#   docker-compose up
#
#   # Run with Kanboard for end-to-end testing
#   docker-compose --profile full up
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # MCP Server with SSE Transport
  # Connect via: http://localhost:8081/sse
  # ---------------------------------------------------------------------------
  mcp-sse:
    build:
      context: .
      target: runtime
    container_name: kanboard-mcp-sse
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      - MCP_MODE=sse
      - MCP_PORT=8080
      - KANBOARD_API_ENDPOINT=${KANBOARD_API_ENDPOINT:-http://kanboard:80/jsonrpc.php}
      - KANBOARD_API_KEY=${KANBOARD_API_KEY}
      - KANBOARD_USERNAME=${KANBOARD_USERNAME:-}
      - KANBOARD_PASSWORD=${KANBOARD_PASSWORD:-}
      - KANBOARD_AUTH_METHOD=${KANBOARD_AUTH_METHOD:-global_token}
      - KANBOARD_DEBUG=${KANBOARD_DEBUG:-false}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - kanboard-net

  # ---------------------------------------------------------------------------
  # MCP Server with Streamable HTTP Transport (Recommended for containers)
  # Connect via: http://localhost:8082/mcp
  # ---------------------------------------------------------------------------
  mcp-http:
    build:
      context: .
      target: runtime
    container_name: kanboard-mcp-http
    restart: unless-stopped
    ports:
      - "8082:8080"
    environment:
      - MCP_MODE=streamablehttp
      - MCP_PORT=8080
      - KANBOARD_API_ENDPOINT=${KANBOARD_API_ENDPOINT:-http://kanboard:80/jsonrpc.php}
      - KANBOARD_API_KEY=${KANBOARD_API_KEY}
      - KANBOARD_USERNAME=${KANBOARD_USERNAME:-}
      - KANBOARD_PASSWORD=${KANBOARD_PASSWORD:-}
      - KANBOARD_AUTH_METHOD=${KANBOARD_AUTH_METHOD:-global_token}
      - KANBOARD_DEBUG=${KANBOARD_DEBUG:-false}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - kanboard-net

  # ---------------------------------------------------------------------------
  # MCP Server with stdio Transport (for interactive/direct testing)
  # Run with: docker-compose run --rm mcp-stdio
  # ---------------------------------------------------------------------------
  mcp-stdio:
    build:
      context: .
      target: runtime
    container_name: kanboard-mcp-stdio
    stdin_open: true
    tty: true
    environment:
      - MCP_MODE=stdio
      - KANBOARD_API_ENDPOINT=${KANBOARD_API_ENDPOINT:-http://kanboard:80/jsonrpc.php}
      - KANBOARD_API_KEY=${KANBOARD_API_KEY}
      - KANBOARD_USERNAME=${KANBOARD_USERNAME:-}
      - KANBOARD_PASSWORD=${KANBOARD_PASSWORD:-}
      - KANBOARD_AUTH_METHOD=${KANBOARD_AUTH_METHOD:-global_token}
      - KANBOARD_DEBUG=${KANBOARD_DEBUG:-false}
    networks:
      - kanboard-net

  # ---------------------------------------------------------------------------
  # Kanboard Server (optional, for full end-to-end testing)
  # Web UI: http://localhost:8080
  # Default credentials: admin / admin
  # ---------------------------------------------------------------------------
  kanboard:
    image: kanboard/kanboard:latest
    container_name: kanboard
    profiles:
      - full
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - kanboard-data:/var/www/app/data
      - kanboard-plugins:/var/www/app/plugins
    environment:
      - DATABASE_URL=${DATABASE_URL:-}
    networks:
      - kanboard-net

networks:
  kanboard-net:
    driver: bridge

volumes:
  kanboard-data:
  kanboard-plugins:
